# PPA 插件部署指南

本文档说明如何将 PPA PowerPoint 插件打包为可分发的安装程序。

## 📦 部署方式概述

VSTO 插件不能直接打包为独立的 exe 文件，因为它需要：

- 安装到 PowerPoint 插件系统
- 需要 VSTO Runtime 支持
- 需要注册到 Office 的插件注册表

推荐使用以下方式之一进行部署：

---

## 方式一：ClickOnce 部署（推荐）

ClickOnce 是 VSTO 项目最常用的部署方式，可以生成一个自动安装程序。

### 步骤 1：配置发布设置

1. 在 Visual Studio 中打开项目
2. 右键点击项目 → **属性**
3. 选择 **发布** 选项卡
4. 配置以下设置：
   - **发布位置**：选择本地文件夹（如 `bin\Release\publish\`）
   - **安装模式**：选择 **"该应用程序也可以脱机运行"**
   - **发布版本**：设置版本号（如 1.0.0.0）
   - **自动递增修订号**：根据需要勾选

### 步骤 2：配置先决条件

1. 在 **发布** 选项卡中，点击 **先决条件** 按钮
2. 确保以下项已勾选：
   - ✅ **Microsoft .NET Framework 4.8**（x86 和 x64）
   - ✅ **Microsoft Visual Studio 2010 Tools for Office Runtime**（x86 和 x64）
   - ✅ **Windows Installer 3.1**（通常已包含）

### 步骤 3：配置更新设置

1. 在 **发布** 选项卡中，点击 **更新** 按钮
2. 配置更新策略：
   - **应用程序应检查更新**：根据需要选择
   - **更新位置**：如果使用网络共享或网站，填写 URL
   - **更新频率**：建议设置为每次启动时检查

### 步骤 4：配置选项

1. 在 **发布** 选项卡中，点击 **选项** 按钮
2. 填写发布信息：
   - **发布者名称**：您的名称或公司名称
   - **产品名称**：PPA
   - **支持 URL**：可选，填写支持网站
   - **发布语言**：选择中文（简体）

### 步骤 5：签名设置

1. 在 **签名** 选项卡中，配置代码签名：
   - 如果已有代码签名证书，选择证书文件
   - 如果没有，可以使用临时证书（项目已包含 `PPA_TemporaryKey.pfx`）
   - ⚠️ **注意**：使用临时证书会显示安全警告，建议使用正式证书

### 步骤 6：发布项目

1. 在 **发布** 选项卡中，点击 **立即发布** 按钮
2. Visual Studio 会：
   - 编译 Release 版本
   - 生成 ClickOnce 安装文件
   - 创建 `publish` 文件夹

### 步骤 7：分发安装包

发布完成后，在 `bin\Release\publish\` 目录下会生成：

- `setup.exe` - 安装程序（推荐使用）
- `PPA.application` - ClickOnce 应用程序清单
- 其他依赖文件

**分发方式**：

- 将整个 `publish` 文件夹打包（ZIP 或 RAR）
- 或者只分发 `setup.exe`（它会自动下载依赖）

### 用户安装步骤

1. 用户运行 `setup.exe`
2. 安装程序会自动检查并安装先决条件（.NET Framework、VSTO Runtime）
3. 安装完成后，重启 PowerPoint
4. 插件会自动加载

### 安装位置说明

ClickOnce 部署的插件安装后，文件存储在用户的本地应用程序数据目录中：

**默认路径**：

```
C:\Users\{用户名}\AppData\Local\Apps\2.0\{随机字符串}\{随机字符串}\{应用名}_{版本号}_{令牌}\
```

**特点**：

- 每个用户独立安装目录
- 不同版本隔离存储
- 路径包含随机字符串（安全隔离）
- 文件可能被重命名为 `.deploy` 扩展名（ClickOnce 自动处理）

**查找方法**：

- 通过注册表：`HKEY_CURRENT_USER\Software\Microsoft\Office\PowerPoint\Addins\PPA`
- 通过文件搜索：在 `C:\Users\{用户名}\AppData\Local\Apps\2.0\` 中搜索 "PPA"
- 使用 PowerShell：`Get-ChildItem -Path "$env:LOCALAPPDATA\Apps\2.0" -Recurse -Filter "PPA.dll"`

📖 **详细说明**：请查看 `ClickOnce安装位置说明.md` 文件

---

## 方式二：使用 Visual Studio Installer Projects（MSI 安装程序）

如果希望创建传统的 MSI 安装程序，可以使用 Visual Studio Installer Projects 扩展。

### 安装扩展

1. 在 Visual Studio 中，选择 **扩展** → **管理扩展**
2. 搜索 **"Microsoft Visual Studio Installer Projects"**
3. 安装并重启 Visual Studio

### 创建安装项目

1. 右键点击解决方案 → **添加** → **新建项目**
2. 选择 **Visual Studio Installer** → **Setup Project**
3. 命名为 `PPAInstaller`

### 配置安装项目

1. **添加项目输出**：

   - 右键点击安装项目 → **添加** → **项目输出**
   - 选择 PPA 项目
   - 选择 **主输出**

2. **添加文件**：

   - 添加 `Ribbon.xml` 和图标资源文件
   - 确保这些文件包含在输出中

3. **配置先决条件**：

   - 右键点击安装项目 → **属性**
   - 点击 **先决条件**
   - 勾选：
     - ✅ .NET Framework 4.8
     - ✅ Visual Studio Tools for Office Runtime

4. **配置安装信息**：

   - 设置产品名称、版本、制造商等信息

5. **生成安装程序**：
   - 右键点击安装项目 → **生成**
   - 在 `bin\Release\` 目录下会生成 `.msi` 文件

---

## 方式三：使用 WiX Toolset（高级）

WiX 是一个专业的 Windows 安装程序创建工具，适合需要更多自定义的场景。

### 安装 WiX

1. 下载并安装 [WiX Toolset](https://wixtoolset.org/)
2. 安装 Visual Studio 扩展 **"WiX Toolset Visual Studio Extension"**

### 创建 WiX 项目

1. 添加新项目 → 选择 **WiX v3** → **Setup Project**
2. 编写 WiX 脚本（.wxs 文件）配置安装逻辑
3. 生成 MSI 安装程序

---

## 方式四：使用第三方打包工具

可以使用 Inno Setup、NSIS 等工具创建安装程序。

### Inno Setup 示例脚本

```inno
[Setup]
AppName=PPA PowerPoint Plugin
AppVersion=1.0.0
DefaultDirName={pf}\PPA
DefaultGroupName=PPA
OutputDir=installer
OutputBaseFilename=PPA_Setup

[Files]
Source: "bin\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

[Run]
Filename: "{dotnet48}"; Parameters: "/q"; StatusMsg: "Installing .NET Framework 4.8..."; Check: not IsDotNetInstalled
Filename: "{tmp}\vstor_redist.exe"; Parameters: "/q"; StatusMsg: "Installing VSTO Runtime..."; Check: not IsVSTORInstalled
```

---

## 📋 部署检查清单

在发布前，请确保：

- [ ] 项目已编译为 **Release** 配置
- [ ] 所有依赖项已正确引用
- [ ] 资源文件（图标、Ribbon.xml）已包含在输出中
- [ ] 版本号已更新
- [ ] 代码签名证书已配置（可选但推荐）
- [ ] 先决条件已正确配置
- [ ] 在干净的测试环境中测试安装

---

## 🔧 常见问题

### 1. 用户安装后插件未加载

**可能原因**：

- VSTO Runtime 未正确安装
- 插件未正确注册
- PowerPoint 信任中心阻止了插件

**解决方法**：

- 确保 VSTO Runtime 已安装
- 检查 PowerPoint 信任中心设置
- 查看 Windows 事件查看器中的错误日志

### 2. 安全警告

**原因**：使用临时证书或未签名

**解决方法**：

- 使用正式代码签名证书签名
- 或指导用户添加发布者为受信任的发布者

### 3. 依赖项缺失

**解决方法**：

- 确保先决条件配置正确
- 安装程序会自动下载并安装依赖项

### 4. 菜单无法加载（Ribbon.xml 问题）

**问题现象**：

- 发布后插件菜单无法显示

**解决方案**：

- ✅ **已优化**：`Ribbon.xml` 已改为嵌入式资源，由 .NET Framework 自动处理
- 不再需要处理 `.deploy` 文件问题
- 资源会被编译到程序集中，更安全可靠
- 重新编译并发布项目即可

**技术说明**：

- `Ribbon.xml` 现在作为 `EmbeddedResource` 编译到程序集中
- 使用 `Assembly.GetManifestResourceStream` 加载，无需文件系统访问
- 完全兼容 ClickOnce 部署，无需特殊处理

### 5. 本地化资源文件（resources.dll.deploy）

**问题现象**：

- 在发布文件夹中看到 `en-US\PPA.resources.dll.deploy`、`zh-CN\PPA.resources.dll.deploy` 等文件

**说明**：

- ✅ **这是正常现象**：ClickOnce 会将所有文件（包括卫星程序集）重命名为 `.deploy` 扩展名
- .NET Framework 的 `ResourceManager` 会自动处理 `.deploy` 文件，无需额外代码
- 资源加载机制通过程序集加载器工作，ClickOnce 运行时知道如何处理这些文件

**如果遇到资源加载问题**：

- 检查日志输出，确认资源管理器是否正常初始化
- 确认资源文件已正确编译到卫星程序集中
- 检查 `Properties\Resources.*.resx` 文件是否都包含在项目中

---

## 📝 发布说明模板

创建 `发布说明.txt` 文件，包含：

```
PPA PowerPoint 插件 v1.0.0
============================

系统要求：
- Windows 7 或更高版本
- Microsoft PowerPoint 2016 或更高版本
- .NET Framework 4.8
- Visual Studio Tools for Office Runtime

安装步骤：
1. 运行 setup.exe
2. 按照安装向导完成安装
3. 重启 PowerPoint
4. 插件将自动加载

卸载步骤：
1. 控制面板 → 程序和功能
2. 找到 "PPA" 并卸载

技术支持：
- GitHub: https://github.com/sandorn/PPA
- Issues: https://github.com/sandorn/PPA/issues
```

---

## 🚀 快速发布命令（命令行）

如果使用命令行构建和发布：

```powershell
# 构建 Release 版本
msbuild PPA.sln /p:Configuration=Release /p:Platform="Any CPU"

# 发布 ClickOnce（需要先配置发布设置）
msbuild PPA.csproj /t:Publish /p:Configuration=Release /p:PublishUrl="bin\Release\publish\"
```

---

## 📦 最终分发包结构

建议的分发包结构：

```
PPA_v1.0.0_Release.zip
├── setup.exe                    # ClickOnce 安装程序
├── PPA.application              # 应用程序清单
├── 发布说明.txt                 # 安装说明
├── README.md                    # 项目说明
└── [其他依赖文件]
```

---

## ✅ 推荐方案

对于大多数情况，**推荐使用 ClickOnce 部署**（方式一），因为：

- ✅ 简单易用，Visual Studio 内置支持
- ✅ 自动处理依赖项安装
- ✅ 支持自动更新
- ✅ 用户安装体验好

如果需要更多控制或企业部署，可以考虑 **MSI 安装程序**（方式二或三）。

---

## 📞 需要帮助？

如果遇到问题，请：

1. 查看项目 README.md
2. 查看 GitHub Issues
3. 提交新的 Issue 描述问题
