把“新增三线表功能”后续可优化的点按照 **接口设计 / 实现细节 / 性能与可维护性 / 交互体验 / 易改动项** 五个维度梳理如下。

---

## 1. 接口与模型层面

### 1.1 TableFormatOptions 字段未充分使用

- `ApplyBorders`、`ApplyFont` 在 `FormatTable` 中没有任何判断。
- `AutoNumberFormat`、`DecimalPlaces`、`NegativeTextColor` 也没有实现逻辑。

**风险**：调用方会误以为这些选项生效，造成“伪选项”隐患。

**建议**：

1. 尽快为这些字段补齐实现；或
2. 临时移除 / `[Obsolete]` 标记，避免误导。

### 1.2 默认配置重复度高

`FormatTableWithDefaults` 与 `CreateThreeLineOptions` 都在构造 `TableFormatOptions`，但字体、对齐、背景等字段类似却不统一。

**建议**：抽取 `CreateBaseOptions()` 等公共方法，三线表与默认格式在基础模板上做差异化配置，以减少分散的魔法数。

### 1.3 三线表可配置性不足

`FormatTableAsThreeLine` 目前是“全固定模板”：字体、字号、对齐、边框颜色全部写死。

**建议（按需）**：保留快捷方法，同时提供 `FormatTableAsThreeLine(table, TableFormatOptions overrides)` 可选重载，让调用方按模板覆写个别属性。

---

## 2. 实现细节可收敛点

### 2.1 未根据 ApplyBorders / ApplyFont 控制 SetRowStyle

`SetRowStyle` 无条件设置字体与边框，只检查 `RowStyle` 是否提供，不参考 `options.ApplyFont / ApplyBorders`。

**建议**：

- 将 `ApplyFont` / `ApplyBorders` 通过参数传入 `SetRowStyle`；或
- 在 `RowStyle` 中增加布尔开关；
- 亦可拆成 `ApplyFontToRow`、`ApplyBordersToRow` 两个方法。

### 2.2 “第三条线”语义分散

- 表头：上 + 下边框；
- 数据行：无边框；
- 末行：`SetLastRowBottomBorder` 复用表头边框。

逻辑正确，但“第三条线”藏在 `FormatTable` 尾部，理解成本较大。

**建议**：在 `CreateThreeLineOptions` 加注释说明 “第三条线通过 `SetLastRowBottomBorder` 使用表头边框实现”。

### 2.3 SetRowStyle 判空可进一步封装

目前行范围已在方法入口控制，循环内仍需逐列 `GetCell` → `if (cell == null)`。

**建议**：后续可结合平台能力（是否支持行级 range）做更优封装，详见性能章节。

---

## 3. 性能与可维护性

### 3.1 逐单元格调用成本高

`SetRowStyle` = 行 × 列 × 多个跨进程调用（背景 / 字体 / 对齐 / 边框），对 COM 接口是明显瓶颈。

**建议**：

1. 在 `ITableContext` 扩充批量 API（如 `GetRowRange`、`SetRowBorders`）；
2. 即使无批量 API，也可把“边框”“字体”拆成两轮遍历，减轻重复调用。

### 3.2 均分宽高方法缺少边界保护

`DistributeColumnWidths` / `DistributeRowHeights` 目前未考虑列宽为 0 或异常值。

**建议**：若未来三线表要联动自动均分，提前加健壮性检查与容错日志。

### 3.3 日志粒度略粗

现有日志只有“开始/完成三线表”，排查兼容性问题（WPS vs PPT）较费劲。

**建议（轻量）**：在 `FormatTableAsThreeLine` 或 `FormatTable` 输出 DEBUG 级别信息（行列、是否应用表头/数据行、是否设置末行边框等）。

---

## 4. ComAddIn 交互与异常处理

### 4.1 Ribbon 回调体验

`OnFormatThreeLineTable` 已覆盖常见边界：

- 未选中形状 → “请先选择包含表格的形状”；
- 形状中无表格 → “选中形状中没有表格”；
- 服务为空 → “表格格式化服务不可用”。

**可扩展点**：

1. 多表处理的可见反馈：日志已有 “已对 X 个表格应用三线表格式”，可考虑在 X>1 时弹轻量提示；
2. 长耗时操作提示：若未来支持批处理，可加“正在处理，请稍候”提示或提升日志级别。

### 4.2 与旧格式化入口的兼容

三线表仅走 `FormatTableAsThreeLine → FormatTable`，不会触达 `FormatTableWithDefaults`。

**风险**：若先运行默认格式，再套三线表，可能残留旧边框（旧版本内部竖线）。

**建议**：三线表逻辑中显式“清除非三线边框”，确保与旧功能互操作无冲突。

---

## 5. 易于落地的小优化

这些属于“行为不变”的重构，可逐步清理：

1. **统一字体/主题常量**：如 "等线"、主题色 13，可集中定义，便于后续统一规范。
2. **抽取公共样式 Helper**：`CreateThreeLineOptions` 中 header/data 共用字段（字体、FarEast 字体、背景隐藏）可由 helper 填充，减少重复。

---

## 6. 需求优先级建议

目前三线表整体逻辑可用，建议优先考虑：

1. **接口一致性**：让 `TableFormatOptions` 选项“名副其实”；
2. **大表性能**：减少单元格级跨进程调用；
3. **可配置能力**：满足不同模板的三线表需求。

你可以告知更关注的方向（性能 / 可维护性 / 样式体验），我可以按优先级拆成若干小 PR，区分“仅重构”与“对用户可见的变更”，方便 review。

---

## 7. 配置驱动的三线表说明

> 下面内容描述的是**当前实现**：三线表已从 `PPAConfig.xml` 读取样式，不再写死在代码中。

### 7.1 配置入口概览

- 配置文件路径（默认）：`%LOCALAPPDATA%\PPA.Universal\PPAConfig.xml`。
- 加载位置：`UniversalBootstrapper.InitializeDIContainer` 中 `PPAConfig.LoadOrCreate(configPath)`。
- 业务使用：`TableFormatService` 通过依赖注入接收 `PPAConfig`，在 `CreateThreeLineOptions()` 中读取 `PPAConfig.Table` 构造 `TableFormatOptions`。

即：`ComAddIn → ITableFormatService.FormatTableAsThreeLine → TableFormatService.CreateThreeLineOptions → PPAConfig.Table`。

### 7.2 `<Table>` 关键字段说明

`PPAConfig.Table` 对应 XML 结构：

```xml
<Table
  StyleId="{5940675A-B579-460E-94D1-54222C63F5DA}"
  DataRowBorderWidth="1"
  HeaderRowBorderWidth="1.75"
  FinalRowBorderWidth="1.75"
  DataRowBorderColorIndex="13"
  HeaderRowBorderColorIndex="13"
  FinalRowBorderColorIndex="13"
  AutoNumberFormat="true"
  DecimalPlaces="0"
  NegativeTextColor="255">
  <DataRowFont Name="+mn-lt" NameFarEast="+mn-ea" Size="9"  Bold="false" ThemeColorIndex="13" />
  <HeaderRowFont Name="+mn-lt" NameFarEast="+mn-ea" Size="10" Bold="true"  ThemeColorIndex="13" />
  <TableSettings FirstRow="false" FirstCol="false" LastRow="false" LastCol="false" HorizBanding="false" VertBanding="false" />
</Table>
```

- **StyleId**

  - 对应 PPT/WPS 的表格样式 GUID。
  - 当前实现：
    - 若非空：`ApplyTableStyle = true`，调用 `table.ApplyStyle(StyleId)`。
    - 若为空：`ApplyTableStyle = false`，仅使用我们自己的边框/字体三线表逻辑（避免样式底色干扰）。

- **边框宽度与主题色索引**

  - `HeaderRowBorderWidth` / `DataRowBorderWidth` / `FinalRowBorderWidth`：单位为 pt，映射到 `BorderStyle.Weight`。
  - `HeaderRowBorderColorIndex` / `DataRowBorderColorIndex` / `FinalRowBorderColorIndex`：
    - 数值索引，对应 `MsoThemeColorIndex`（详见 `docs/PPT主题颜色参考.md`）。
    - 由 `BorderStyle.SolidTheme(themeColorIndex, weight)` 生成三线表的三条线：
      - 表头上边框
      - 表头下边框
      - 末行下边框（如未单独配置 `FinalRow*`，则回退使用表头边框样式）。

- **数字格式相关**
  - `AutoNumberFormat`：是否启用自动数字格式（当前仅挂在 `TableFormatOptions`，后续可在数值格式化逻辑中生效）。
  - `DecimalPlaces`：保留小数位数。
  - `NegativeTextColor`：负数文本颜色（RGB 整数）。

### 7.3 字体配置说明（HeaderRowFont / DataRowFont）

`HeaderRowFont` 和 `DataRowFont` 均映射为 `RowStyle` 的字体相关字段：

- `Name` / `NameFarEast` → `RowStyle.FontName` / `FontNameFarEast`
- `Size` → `RowStyle.FontSize`
- `Bold` → `RowStyle.Bold`
- `ThemeColorIndex` → `RowStyle.ThemeColorIndex`

当前实现约定：

- 表头：
  - 居中对齐：`Alignment = TextAlignment.Center`。
  - 上下两条线均为表头边框配置。
- 数据行：
  - 同样居中对齐。
  - 默认只使用“上边框”（`DataRowBorder*`），底部边框为空，由末行统一绘制“第三条线”。

### 7.4 主题色索引与兼容旧写法

- 统一通过 `ThemeColorIndexHelper` 解析：
  - 支持字符串名称：`Dark1`、`Light1`、`Accent1` ~ `Accent6`、`Hyperlink`、`FollowedHyperlink`、`Text1`、`Background1`、`Text2`、`Background2`。
  - 也支持直接写数字：如 `ThemeColorIndex="13"`。
- 兼容旧配置：
  - `TableConfig` 的 `DataRowBorderColor` / `HeaderRowBorderColor` / `FinalRowBorderColor`（字符串型）
  - `FontConfig` / `BulletConfig` 的 `ThemeColor`（字符串型）
  - 解析逻辑：
    - 若对应的 `*ColorIndex` / `ThemeColorIndex` 为空，则尝试把字符串解析为索引写回；
    - 这样可以平滑过渡到“统一用数值索引”的新写法。

### 7.5 对 WPS 三线表视觉的影响

- 三线表在 WPS 中仍然采用“强制白底覆盖表格样式底色”的策略：
  - `RowStyle.HideBackground = true` 时：
    - WPS：`cell.SetBackground(16777215); cell.SetBackgroundVisible(true);`
    - PPT：`cell.SetBackgroundVisible(false);`
- 因此：
  - **颜色 / 线宽 / 字体** 可以通过 `PPAConfig.Table` 配置灵活调整；
  - **白底覆盖残留背景** 的行为保持不变，避免重新暴露 WPS 表格样式的花纹或底色。

### 7.6 调整三线表样式的推荐方式

常见调整场景示例：

- **禁止套用任何 PPT/WPS 表格样式，仅保留“纯线条三线表”**：

  - 将 `<Table>` 的 `StyleId` 置空或删除该属性。

- **统一改用 Accent1 颜色**：

  - 将 `HeaderRowBorderColorIndex` / `FinalRowBorderColorIndex` 改为 `4`，或使用旧写法 `HeaderRowBorderColor="Accent1"`。

- **加粗末行“第三条线”**：
  - 只调 `FinalRowBorderWidth`，颜色沿用表头线；
  - 或同时设置 `FinalRowBorderColorIndex` 以使用完全不同的颜色。

这些改动都不需要重新编译，只需修改 `PPAConfig.xml` 后重新加载加载项即可生效.
