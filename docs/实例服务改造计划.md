# 实例服务改造计划

## 背景

- 文本、表格、图表批量处理均已改为实例服务，通过 DI 管理。
- ~~形状批量处理仍旧是静态类，运行期自行解析 `IShapeHelper`，与整体架构不符。~~ ✅ **已完成改造**
- 标准化实例服务后，依赖更清晰、便于测试，也能统一日志与错误处理。

## 改造目标（已完成）

1. ✅ 将 `ShapeBatchHelper` 改为实例服务，构造函数注入依赖。
2. ✅ 为形状批量处理定义接口 `IShapeBatchHelper`，方便 DI 与调用者解耦。
3. ✅ 梳理项目里剩余的静态业务类，列出改造优先级和保持静态的清单。

## 改造步骤（已完成）

1. ✅ 定义接口 `IShapeBatchHelper`

   - 已新增到 `Core/Abstraction/Business/`。
   - 方法：`CreateBoundingBox(NETOP.Application app)`、`ToggleShapeVisibility(NETOP.Application app)`。

2. ✅ 重写 `ShapeBatchHelper`

   - 类已改为 `internal class ShapeBatchHelper : IShapeBatchHelper`。
   - 构造函数注入 `IShapeHelper`、`ILogger`。
   - 已删除 `ResolveShapeHelper()` 与所有静态字段。
   - 方法已实现接口定义。

3. ✅ 注册 DI

   - 已在 `ServiceCollectionExtensions` 中注册：`services.AddTransient<IShapeBatchHelper, ShapeBatchHelper>();`

4. ✅ 调整调用方

   - `RibbonCommandRouter` 已通过构造函数注入 `IShapeBatchHelper`。
   - `KeyboardShortcutHelper` 已改为从 DI 容器解析 `IShapeBatchHelper`。

5. ✅ 验证
   - Bt401、Bt601、相关快捷键与 Ribbon 按钮功能正常。
   - 日志中不再出现 "ResolveShapeHelper" 等字样。

## 已完成改造

✅ **ShapeBatchHelper** - 已改为实例服务，通过 DI 注入 `IShapeHelper` 和 `ILogger`

## 保持静态类清单（确认）

以下类**保持静态**，无需改造为实例服务：

### 1. 纯工具类（无状态，纯函数式）

- ✅ **AdapterUtils** - `PPA/Core/Adapters/AdapterUtils.cs` - 适配器工具类，提供 NetOffice 与抽象接口的双向转换
- ✅ **ExHandler** / **ExFormatter** - `PPA/Core/ExHandler.cs` - 异常处理工具类，提供统一的异常捕获和格式化
- ✅ **ConfigHelper** - `PPA/Formatting/FormattingConfig.cs` - 配置辅助工具类，提供配置值转换方法
- ✅ **ComListExtensions** - `PPA/Utilities/ComListExtensions.cs` - COM 列表扩展方法类
- ✅ **ServiceCollectionExtensions** - `PPA/Core/DI/ServiceCollectionExtensions.cs` - DI 容器扩展方法类
- ✅ **FileLocator** - `PPA/Utilities/FileLocator.cs` - 文件定位工具类，在多个位置搜索文件

### 2. 单例模式工具类

- ✅ **LoggerProvider** - `PPA/Core/Logging/LoggerProvider.cs` - 日志提供者，提供全局日志实例（单例模式）
- ✅ **ResourceManager** - `PPA/Core/ResourceManager.cs` - 资源管理器，管理多语言资源（单例模式）
- ✅ **Profiler** / **ProfilerEx** - `PPA/Core/Profiler.cs` - 性能监控工具，提供方法执行时间测量和日志功能

### 3. 业务工具类（简单封装，适合静态）

- ✅ **MSOICrop** - `PPA/Shape/MSOICrop.cs` - 形状裁剪工具，使用布尔运算实现裁剪（纯函数式）
- ✅ **UndoHelper** - `PPA/Formatting/UndoHelper.cs` - 撤销操作助手，封装 PowerPoint 的撤销/重做 API
- ✅ **ApplicationHelper** - `PPA/Utilities/ApplicationHelper.cs` - Application 对象获取工具，提供 NetOffice 和 Native COM 对象转换
- ✅ **Toast** - `PPA/Utilities/Toast.cs` - Toast 通知管理器，提供单消息框模式的用户提示
- ✅ **AsyncOperationHelper** - `PPA/Utilities/AsyncOperationHelper.cs` - 异步操作助手，提供统一的异步操作执行框架

### 4. 常量/枚举类

- ✅ **OfficeCommands** - `PPA/Core/Abstraction/Business/OfficeCommands.cs` - Office 命令常量类，定义 PowerPoint MSO 命令 ID

## 可能需要评估的类

### KeyboardShortcutHelper

**文件位置**：`PPA/UI/KeyboardShortcutHelper.cs`

**当前状态**：静态类，管理全局快捷键

**评估**：

- 优点（保持静态）：全局快捷键是系统级功能，静态访问更直观
- 缺点（改为实例）：如果需要支持多实例或测试，可能需要实例化

**建议**：**保持静态**，除非后续需要支持多实例场景或更复杂的快捷键管理逻辑

## 总结

- ✅ **已改造**：`ShapeBatchHelper` → 实例服务
- ✅ **保持静态**：所有工具类、单例类、简单封装类均保持静态
- 📝 **评估中**：`KeyboardShortcutHelper`（建议保持静态）

**原则**：

- 有状态、需要依赖注入的业务类 → 改为实例服务
- 无状态、纯函数式的工具类 → 保持静态
- 单例模式的资源管理类 → 保持静态
- 简单封装的 API 包装类 → 保持静态
