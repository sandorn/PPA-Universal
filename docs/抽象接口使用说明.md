# æŠ½è±¡æ¥å£ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ PPA é¡¹ç›®ä¸­æŠ½è±¡æ¥å£ï¼ˆ`IApplication`ã€`IPresentation`ã€`IShape` ç­‰ï¼‰çš„ä½¿ç”¨åœºæ™¯ã€æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ã€‚

---

## 1. ä¸ºä»€ä¹ˆä¿ç•™æŠ½è±¡æ¥å£ï¼Ÿ

è™½ç„¶å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒ PowerPointï¼ˆWPS æ”¯æŒå·²åºŸå¼ƒï¼‰ï¼Œä½†æŠ½è±¡æ¥å£ä»å…·æœ‰ä»¥ä¸‹ä»·å€¼ï¼š

### 1.1 æµ‹è¯•æ”¯æŒ âœ…

æŠ½è±¡æ¥å£å…è®¸åˆ›å»º Mock å¯¹è±¡è¿›è¡Œå•å…ƒæµ‹è¯•ï¼š

```csharp
// ç¤ºä¾‹ï¼šåˆ›å»º Mock IApplication è¿›è¡Œæµ‹è¯•
public class MockApplication : IApplication
{
    public ApplicationType ApplicationType => ApplicationType.PowerPoint;
    public IPresentation GetActivePresentation() => new MockPresentation();
    // ... å…¶ä»–æ–¹æ³•å®ç°
}

// åœ¨æµ‹è¯•ä¸­ä½¿ç”¨
[Test]
public void TestAlignment()
{
    var mockApp = new MockApplication();
    var helper = new AlignHelper();
    helper.ExecuteAlignment(mockApp, AlignmentType.Left, true);
    // éªŒè¯ç»“æœ...
}
```

### 1.2 ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰é›†æˆ âœ…

æŠ½è±¡æ¥å£ä¸ä¾èµ–æ³¨å…¥æ¡†æ¶è‰¯å¥½é›†æˆï¼š

```csharp
// åœ¨ DI å®¹å™¨ä¸­æ³¨å†Œ
services.AddSingleton<IApplicationFactory, PowerPointApplicationFactory>();
services.AddTransient<IApplication>(sp =>
    sp.GetRequiredService<IApplicationFactory>()?.GetCurrent());

// åœ¨æœåŠ¡ä¸­ä½¿ç”¨
public class MyService
{
    private readonly IApplication _app;
    public MyService(IApplication app) // é€šè¿‡ DI æ³¨å…¥
    {
        _app = app;
    }
}
```

### 1.3 ä»£ç è§£è€¦ âœ…

ä¸šåŠ¡å±‚ä¸ç›´æ¥ä¾èµ–å…·ä½“çš„ NetOffice ç±»å‹ï¼Œé™ä½è€¦åˆåº¦ï¼š

```csharp
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨æŠ½è±¡æ¥å£
public void ProcessShapes(IApplication app)
{
    var shapes = app.GetSelectedShapes();
    // å¤„ç†é€»è¾‘...
}

// âŒ ä¸å¥½çš„åšæ³•ï¼šç›´æ¥ä¾èµ–å…·ä½“ç±»å‹
public void ProcessShapes(NETOP.Application app)
{
    // ç›´æ¥ä¾èµ– NetOffice ç±»å‹ï¼Œè€¦åˆåº¦é«˜
}
```

---

## 2. ä½•æ—¶ä½¿ç”¨æŠ½è±¡æ¥å£ï¼Ÿ

### 2.1 âœ… åº”è¯¥ä½¿ç”¨æŠ½è±¡æ¥å£çš„åœºæ™¯

| åœºæ™¯                   | è¯´æ˜                     | ç¤ºä¾‹                                              |
| ---------------------- | ------------------------ | ------------------------------------------------- |
| **ä¸šåŠ¡é€»è¾‘æ–¹æ³•å‚æ•°**   | ä¸šåŠ¡å±‚æ–¹æ³•åº”ä½¿ç”¨æŠ½è±¡æ¥å£ | `ExecuteAlignment(IApplication app, ...)`         |
| **ä¾èµ–æ³¨å…¥çš„æœåŠ¡æ¥å£** | é€šè¿‡ DI æ³¨å…¥çš„æœåŠ¡       | `public MyService(IApplication app)`              |
| **å•å…ƒæµ‹è¯•**           | åˆ›å»º Mock å¯¹è±¡è¿›è¡Œæµ‹è¯•   | `var mockApp = new MockApplication()`             |
| **æ¥å£å®šä¹‰**           | ä¸šåŠ¡æ¥å£çš„æ–¹æ³•ç­¾å       | `IAlignHelper.ExecuteAlignment(IApplication app)` |

### 2.2 âŒ ä¸éœ€è¦ä½¿ç”¨æŠ½è±¡æ¥å£çš„åœºæ™¯

| åœºæ™¯              | è¯´æ˜                   | ç¤ºä¾‹                                                 |
| ----------------- | ---------------------- | ---------------------------------------------------- |
| **åº•å±‚ COM æ“ä½œ** | ç›´æ¥æ“ä½œ COM å¯¹è±¡æ—¶    | `MSOP.Application nativeApp`                         |
| **æ€§èƒ½å…³é”®è·¯å¾„**  | éœ€è¦ç›´æ¥è®¿é—®åŸç”Ÿå¯¹è±¡æ—¶ | `var shape = nativeApp.ActiveWindow.Selection`       |
| **å†…éƒ¨å®ç°ç»†èŠ‚**  | é€‚é…å™¨å†…éƒ¨å®ç°         | `PowerPointApplication` å†…éƒ¨ä½¿ç”¨ `NETOP.Application` |

---

## 3. æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜é€‚é…å™¨å¯¹è±¡

ä¸ºäº†é¿å…é‡å¤åˆ›å»ºé€‚é…å™¨å¯¹è±¡ï¼Œå·²å®ç°ç¼“å­˜æœºåˆ¶ï¼š

### 3.1 AlignHelper ä¸­çš„ç¼“å­˜

```csharp
public class AlignHelper
{
    // ç¼“å­˜é€‚é…å™¨å¯¹è±¡ï¼Œé¿å…é‡å¤è½¬æ¢
    private IApplication _cachedApp;
    private NETOP.Application _cachedNativeApp;

    private void InvokeWithNative(IApplication app, Action<NETOP.Application> action)
    {
        // ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è½¬æ¢
        NETOP.Application native;
        if(_cachedApp == app && _cachedNativeApp != null)
        {
            native = _cachedNativeApp; // ä½¿ç”¨ç¼“å­˜
        }
        else
        {
            native = ApplicationHelper.GetNetOfficeApplication(app);
            if(native != null)
            {
                _cachedApp = app;
                _cachedNativeApp = native; // æ›´æ–°ç¼“å­˜
            }
        }
        // ...
    }
}
```

### 3.2 CustomRibbon ä¸­çš„ç¼“å­˜

```csharp
public class CustomRibbon
{
    private IApplication _abstractApp; // ç¼“å­˜å­—æ®µ

    private IApplication GetAbstractApplication()
    {
        // å¦‚æœå·²ç¼“å­˜ä¸”åº”ç”¨å¯¹è±¡å·²åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›
        if(_abstractApp==null && _appInitialized && _app!=null)
        {
            _abstractApp=ResolveAbstractApplication();
        }
        return _abstractApp;
    }
}
```

---

## 4. è½¬æ¢æ¨¡å¼

### 4.1 æŠ½è±¡æ¥å£ â†’ NetOffice å¯¹è±¡

ä½¿ç”¨ `ApplicationHelper.GetNetOfficeApplication()`ï¼š

```csharp
// ä»æŠ½è±¡æ¥å£è·å– NetOffice å¯¹è±¡
IApplication abstractApp = GetAbstractApplication();
NETOP.Application netApp = ApplicationHelper.GetNetOfficeApplication(abstractApp);
```

### 4.2 NetOffice å¯¹è±¡ â†’ æŠ½è±¡æ¥å£

åˆ›å»ºé€‚é…å™¨åŒ…è£…å™¨ï¼š

```csharp
// ä» NetOffice å¯¹è±¡åˆ›å»ºæŠ½è±¡æ¥å£
NETOP.Application netApp = GetNetOfficeApplication();
IApplication abstractApp = new PowerPointApplication(netApp);
```

### 4.3 åŸç”Ÿ COM å¯¹è±¡ â†’ NetOffice å¯¹è±¡

ä½¿ç”¨ `ApplicationHelper.GetNativeComApplication()`ï¼š

```csharp
// è·å–åŸç”Ÿ COM å¯¹è±¡
MSOP.Application nativeApp = ApplicationHelper.GetNativeComApplication();
// åŸç”Ÿ COM å¯¹è±¡é€šå¸¸éœ€è¦ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦è½¬æ¢ä¸º NetOffice
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 æ–¹æ³•ç­¾åè®¾è®¡

```csharp
// âœ… æ¨èï¼šä¸šåŠ¡æ–¹æ³•ä½¿ç”¨æŠ½è±¡æ¥å£
public interface IAlignHelper
{
    void ExecuteAlignment(IApplication app, AlignmentType alignment, bool alignToSlideMode);
}

// âŒ ä¸æ¨èï¼šç›´æ¥ä½¿ç”¨å…·ä½“ç±»å‹ï¼ˆé™¤éæ˜¯åº•å±‚ COM æ“ä½œï¼‰
public void ExecuteAlignment(NETOP.Application app, ...) { }
```

### 5.2 å†…éƒ¨å®ç°

```csharp
// âœ… æ¨èï¼šåœ¨æ–¹æ³•å†…éƒ¨è½¬æ¢ä¸ºå…·ä½“ç±»å‹
public void ExecuteAlignment(IApplication app, ...)
{
    // è½¬æ¢ä¸º NetOffice å¯¹è±¡ï¼ˆå¸¦ç¼“å­˜ä¼˜åŒ–ï¼‰
    var netApp = ApplicationHelper.GetNetOfficeApplication(app);
    if(netApp == null) return;

    // ä½¿ç”¨å…·ä½“ç±»å‹è¿›è¡Œæ“ä½œ
    var selection = netApp.ActiveWindow.Selection;
    // ...
}
```

### 5.3 é¿å…ä¸å¿…è¦çš„è½¬æ¢

```csharp
// âŒ ä¸å¥½ï¼šå¤šæ¬¡è½¬æ¢
public void Method1(IApplication app)
{
    var netApp = ApplicationHelper.GetNetOfficeApplication(app);
    Method2(netApp);
}

public void Method2(NETOP.Application app)
{
    var abstractApp = new PowerPointApplication(app);
    Method3(abstractApp);
}

// âœ… å¥½ï¼šä¿æŒä¸€è‡´çš„æŠ½è±¡å±‚æ¬¡
public void Method1(IApplication app)
{
    Method2(app);
}

public void Method2(IApplication app)
{
    Method3(app);
}
```

---

## 6. å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ–¹æ³•å†…éƒ¨è¿˜è¦è½¬æ¢ä¸ºå…·ä½“ç±»å‹ï¼Ÿ

**A**: å› ä¸ºåº•å±‚ COM æ“ä½œéœ€è¦ç›´æ¥è®¿é—® NetOffice æˆ–åŸç”Ÿ COM å¯¹è±¡ã€‚æŠ½è±¡æ¥å£æä¾›äº†ç»Ÿä¸€çš„å…¥å£ï¼Œä½†å®é™…å®ç°ä»éœ€è¦å…·ä½“ç±»å‹ã€‚

### Q2: ç¼“å­˜æœºåˆ¶ä¼šå½±å“çº¿ç¨‹å®‰å…¨å—ï¼Ÿ

**A**: åœ¨ VSTO å•çº¿ç¨‹æ¨¡å‹ä¸­ï¼Œä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä½†å¦‚æœå°†æ¥æ”¹ä¸ºå¤šçº¿ç¨‹æ¨¡å‹ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨ã€‚

### Q3: å¦‚æœå°†æ¥éœ€è¦æ”¯æŒå…¶ä»–å¹³å°æ€ä¹ˆåŠï¼Ÿ

**A**: æŠ½è±¡æ¥å£æ¶æ„å·²ç»å‡†å¤‡å¥½ï¼Œåªéœ€è¦ï¼š

1. å®ç°æ–°çš„é€‚é…å™¨ï¼ˆå¦‚ `GoogleSlidesApplication`ï¼‰
2. åœ¨ `ApplicationType` æšä¸¾ä¸­æ·»åŠ æ–°ç±»å‹
3. åœ¨ DI å®¹å™¨ä¸­æ³¨å†Œæ–°å·¥å‚

### Q4: æŠ½è±¡æ¥å£ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

**A**: é€šè¿‡ç¼“å­˜æœºåˆ¶ï¼Œæ€§èƒ½å½±å“å¾ˆå°ã€‚é€‚é…å™¨å¯¹è±¡çš„åˆ›å»ºæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåç»­ä½¿ç”¨ç¼“å­˜ï¼Œå¼€é”€å¯å¿½ç•¥ã€‚

---

## 7. ç›¸å…³æ–‡ä»¶

### æŠ½è±¡æ¥å£å®šä¹‰

- `PPA\Core\Abstraction\Presentation\IApplication.cs`
- `PPA\Core\Abstraction\Presentation\IPresentation.cs`
- `PPA\Core\Abstraction\Presentation\IShape.cs`
- `PPA\Core\Abstraction\Presentation\ISlide.cs`

### é€‚é…å™¨å®ç°

- `PPA\Core\Adapters\PowerPoint\PowerPointApplication.cs`
- `PPA\Core\Adapters\PowerPoint\PowerPointPresentation.cs`
- `PPA\Core\Adapters\PowerPoint\PowerPointShape.cs`

### å·¥å…·ç±»

- `PPA\Utilities\ApplicationHelper.cs` - æä¾›ç»Ÿä¸€çš„ Application å¯¹è±¡è·å–æ–¹æ³•

### ä½¿ç”¨ç¤ºä¾‹

- `PPA\Formatting\AlignHelper.cs` - ä¸šåŠ¡å±‚ä½¿ç”¨æŠ½è±¡æ¥å£
- `PPA\UI\CustomRibbon.cs` - UI å±‚ä½¿ç”¨æŠ½è±¡æ¥å£

---

## 8. æ€»ç»“

æŠ½è±¡æ¥å£åœ¨ PPA é¡¹ç›®ä¸­çš„å®šä½ï¼š

1. **ä¸»è¦ç›®çš„**ï¼šæµ‹è¯•æ”¯æŒå’Œä¾èµ–æ³¨å…¥é›†æˆ
2. **æ¬¡è¦ç›®çš„**ï¼šä»£ç è§£è€¦å’Œæœªæ¥æ‰©å±•æ€§
3. **ä¸æ˜¯ç›®çš„**ï¼šå¤šå¹³å°æ”¯æŒï¼ˆå½“å‰ä»…æ”¯æŒ PowerPointï¼‰

é€šè¿‡ç¼“å­˜æœºåˆ¶å’Œåˆç†çš„ä½¿ç”¨æ¨¡å¼ï¼ŒæŠ½è±¡æ¥å£å¸¦æ¥çš„æ€§èƒ½å¼€é”€å¯ä»¥å¿½ç•¥ï¼Œè€Œå…¶å¸¦æ¥çš„æµ‹è¯•ä¾¿åˆ©æ€§å’Œä»£ç è§£è€¦ä»·å€¼æ˜¯å€¼å¾—çš„ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**æœ€åæ›´æ–°**ï¼š2024 å¹´ 11 æœˆ 15 æ—¥  
**ç›¸å…³æ–‡æ¡£**ï¼š[æŠ½è±¡æ¥å£ä»·å€¼åˆ†ææŠ¥å‘Š.md](./æŠ½è±¡æ¥å£ä»·å€¼åˆ†ææŠ¥å‘Š.md)
