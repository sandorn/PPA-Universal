# PPA 架构重构实施路线图

**版本**: v1.0  
**制定日期**: 2025 年 1 月

---

## 📅 总体时间线

```
第1-2周   第3-5周   第6-8周   第9-12周  第13-15周
  │         │         │         │          │
  ├─阶段一─┤         │         │          │
  │ DI基础  │         │         │          │
  │         ├─阶段二─┤         │          │
  │         │业务重构│         │          │
  │         │        ├─阶段三─┤          │
  │         │        │平台抽象│          │
  │         │        │        ├─阶段四──┤
  │         │        │        │WPS适配器│
  │         │        │        │        ├─阶段五─┤
  │         │        │        │        │功能测试│
  │         │        │        │        │        │
  └─────────┴────────┴────────┴────────┴────────┘
    1-2周    2-3周    2-3周    3-4周    2-3周
    总计: 10-15周 (2.5-4个月)
```

---

## 🎯 各阶段概览

### 阶段一：DI 容器基础设施（1-2 周）

**目标**: 建立 DI 容器基础设施

**主要工作**:

- ✅ 安装 DI 容器 NuGet 包（包含依赖项 Microsoft.Bcl.AsyncInterfaces）
- ✅ 创建 DI 容器扩展类
- ✅ 在 ThisAddIn 中初始化 DI 容器
- ✅ 定义核心业务接口
- ✅ 项目编译验证通过

**产出**:

- ✅ DI 容器基础设施已建立
- ✅ 核心接口定义完成
- ✅ 项目可以成功编译

---

### 阶段二：业务层重构（2-3 周）

**目标**: 将静态类转换为实例类，提取接口

**主要工作**:

- ✅ 重构格式化模块（TableFormatHelper 等）
- ✅ 重构批量操作模块（BatchHelper 等）
- ✅ 重构对齐工具模块（AlignHelper）
- ✅ 重构形状工具模块（ShapeUtils）
- ✅ 更新 CustomRibbon 使用 DI
- ✅ 保持向后兼容

**产出**:

- 所有静态类转换为实例类
- 所有接口提取并注册到 DI 容器
- CustomRibbon 通过 DI 获取服务

---

### 阶段三：平台抽象层（2-3 周）

**目标**: 创建平台抽象接口和 PowerPoint 适配器

**主要工作**:

- ✅ 创建平台抽象接口（IApplication, ITable 等）
- ✅ 实现 PowerPoint 适配器
- ✅ 创建 ApplicationFactory
- ✅ 注册平台适配器到 DI 容器
- ✅ 重构业务接口使用平台抽象
- ✅ 更新 ThisAddIn 使用平台抽象

**产出**:

- 平台抽象接口定义完成
- PowerPoint 适配器实现完成
- 业务代码不再直接依赖 NetOffice API

---

### 阶段四：WPS 适配器开发（3-4 周）

**目标**: 实现 WPS 适配器，支持 WPS 演示

**主要工作**:

- ✅ 研究 WPS COM API 文档
- ✅ 创建 WPS 测试环境
- ✅ 验证 WPS COM 互操作性
- ✅ 实现 WPS 适配器类
- ✅ 处理 API 差异和兼容性
- ✅ 更新 ApplicationFactory 支持 WPS

**产出**:

- WPS 适配器实现完成
- 可以在 WPS 中加载插件
- 基本功能测试通过

---

### 阶段五：功能适配和测试（2-3 周）

**目标**: 完成功能适配，确保 PowerPoint 和 WPS 功能正常

**主要工作**:

- ✅ 核心功能适配（表格、文本、图表、对齐）
- ✅ UI 适配（Ribbon、快捷键、对话框）
- ✅ 功能降级处理
- ✅ 功能测试（PowerPoint + WPS）
- ✅ 性能优化
- ✅ 内存泄漏检查

**产出**:

- 所有功能测试通过
- 性能满足要求
- 文档更新完成

---

## 📊 关键里程碑

| 里程碑                  | 时间     | 验收标准                        |
| ----------------------- | -------- | ------------------------------- |
| **M1: DI 基础设施完成** | 第 2 周  | DI 容器可用，接口定义完成       |
| **M2: 业务层重构完成**  | 第 5 周  | 所有静态类已转换，功能正常      |
| **M3: 平台抽象层完成**  | 第 8 周  | PowerPoint 适配器完成，代码解耦 |
| **M4: WPS 适配器完成**  | 第 12 周 | WPS 适配器实现，基本功能可用    |
| **M5: 功能测试完成**    | 第 15 周 | 所有测试通过，可以发布          |

---

## 🔄 迭代计划

### 迭代 1：DI 基础设施（1-2 周）

- 安装 DI 容器
- 定义核心接口
- 初始化 DI 容器

### 迭代 2：格式化模块重构（1 周）

- TableFormatHelper 重构
- TextFormatHelper 重构
- ChartFormatHelper 重构

### 迭代 3：批量操作模块重构（1 周）

- TableBatchHelper 重构
- TextBatchHelper 重构
- ChartBatchHelper 重构

### 迭代 4：工具模块重构（1 周）

- AlignHelper 重构
- ShapeUtils 重构
- CustomRibbon 更新

### 迭代 5：平台抽象接口（1 周）

- 定义 IApplication 等接口
- 定义枚举类型

### 迭代 6：PowerPoint 适配器（2 周）

- 实现 PowerPointApplication
- 实现 PowerPointTable 等
- 创建 ApplicationFactory

### 迭代 7：业务接口迁移（1 周）

- 更新业务接口使用平台抽象
- 更新调用方代码

### 迭代 8：WPS 适配器（3-4 周）

- WPS API 研究
- 实现 WPS 适配器
- 处理 API 差异

### 迭代 9：功能适配（1-2 周）

- 功能适配
- UI 适配

### 迭代 10：测试和优化（1 周）

- 功能测试
- 性能优化
- 文档更新

---

## 📋 每周检查清单

### 第 1 周

- [ ] 安装 DI 容器 NuGet 包
- [ ] 创建 DI 容器扩展类
- [ ] 在 ThisAddIn 中初始化 DI 容器
- [ ] 定义核心业务接口

### 第 2 周

- [ ] 完成 DI 基础设施
- [ ] 开始重构 TableFormatHelper
- [ ] 提取 ITableFormatHelper 接口

### 第 3 周

- [ ] 完成格式化模块重构
- [ ] 开始重构批量操作模块

### 第 4 周

- [ ] 完成批量操作模块重构
- [ ] 开始重构工具模块

### 第 5 周

- [ ] 完成业务层重构
- [ ] 功能测试通过
- [ ] 开始平台抽象接口设计

### 第 6 周

- [ ] 完成平台抽象接口定义
- [ ] 开始实现 PowerPoint 适配器

### 第 7 周

- [ ] 继续实现 PowerPoint 适配器
- [ ] 创建 ApplicationFactory

### 第 8 周

- [ ] 完成 PowerPoint 适配器
- [ ] 更新业务接口使用平台抽象
- [ ] 功能测试通过

### 第 9 周

- [ ] 研究 WPS COM API
- [ ] 创建 WPS 测试环境
- [ ] 验证 WPS COM 互操作

### 第 10 周

- [ ] 开始实现 WPS 适配器
- [ ] 实现 WPSApplication

### 第 11 周

- [ ] 继续实现 WPS 适配器
- [ ] 实现 WPSTable 等

### 第 12 周

- [ ] 完成 WPS 适配器
- [ ] 更新 ApplicationFactory
- [ ] 基本功能测试

### 第 13 周

- [ ] 功能适配
- [ ] UI 适配

### 第 14 周

- [ ] 功能测试
- [ ] 性能优化

### 第 15 周

- [ ] 最终测试
- [ ] 文档更新
- [ ] 准备发布

---

## 🎯 成功标准

### 技术标准

- ✅ 所有代码通过编译
- ✅ 所有功能测试通过
- ✅ 性能满足要求（无明显性能下降）
- ✅ 无内存泄漏

### 架构标准

- ✅ 代码不再直接依赖 NetOffice 或 PowerPoint API
- ✅ 所有服务通过 DI 容器管理
- ✅ 平台差异通过适配器隔离
- ✅ 接口清晰，职责明确

### 质量标准

- ✅ 代码审查通过
- ✅ 单元测试覆盖（如果适用）
- ✅ 文档完整
- ✅ 向后兼容（如果适用）

---

## 📝 注意事项

1. **分阶段实施**: 严格按照阶段顺序实施，每个阶段完成后再进入下一阶段
2. **充分测试**: 每个阶段完成后都要进行充分测试
3. **代码审查**: 重要变更需要进行代码审查
4. **文档同步**: 及时更新相关文档
5. **风险控制**: 遇到问题及时调整计划

---

**文档版本**: v1.0  
**最后更新**: 2025 年 1 月
